/**
 * @file build context menu upon mouse right-click or long-press on touchscreen.
 * @author Ming Pan <m3pan@ucsd.edu>
 * @copyright Ming Pan, University of California San Diego
 */

import { fetchAndDisplayShape, identifyAll } from './mghydro-tools.js';
import { enterDistanceMeasureMode } from './measure.js';
import { formatLatLng } from './utils.js';

let touchTimeout;
let longPressTriggered = false;
let activeContextMenu = null; // Store the current popup
let comidHover = null;

export function setupMenu(map) {

  map.getCanvas().addEventListener('touchstart', (e) => {
    if (e.touches.length !== 1) return; // Only allow single-finger press

    const touch = e.touches[0];
    const rect = map.getCanvas().getBoundingClientRect();
    const point = {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
    const lngLat = map.unproject(point);

    longPressTriggered = false;
    touchTimeout = setTimeout(() => {
      longPressTriggered = true;

      // Manually fire your context menu handler:
      showContextMenu(map, lngLat);
    }, 600); // long-press duration (ms)
  });

  map.getCanvas().addEventListener('touchend', () => {
    clearTimeout(touchTimeout);
  });

  map.getCanvas().addEventListener('touchmove', () => {
    clearTimeout(touchTimeout); // cancel if they drag
  });

  map.on('contextmenu', (e) => {
    showContextMenu(map, e.lngLat);
  });
}

function showContextMenu(map, lngLat) {

  // Remove existing popup if any
  if (activeContextMenu) {
    activeContextMenu.remove();
    activeContextMenu = null;
  }

  var outlet = '';
  if (comidHover!=null) {
    outlet = `COMID ${comidHover}`;
    var comidShape = comidHover;
  } else {
    const ll = formatLatLng(lngLat.lat, lngLat.lng);
    outlet = `${ll}`;
    var comidShape = `${lngLat.lat.toFixed(4)}_${lngLat.lng.toFixed(4)}`;
  }


  // Create a popup with a button
  const popup_right = new maplibregl.Popup({closeButton: false})
    .setLngLat([lngLat.lng, lngLat.lat])
    .setHTML(`
      <div class="btn-group-vertical" role="group" aria-label="Map context menu">
        <button type="button" class="btn btn-sm btn-info"  style="text-align: left" id="target-location"><i class="bi bi-geo-alt"></i> ${outlet}</button>
        <button type="button" class="btn btn-sm btn-outline-primary" style="text-align: left" id="identify-watershed"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-emoji-heart-eyes" viewBox="224.09 149.03 751.9 880.83"><path d="m651.09 798.19c52.523-18.742 108.56-74.375 121.64-128.44 0.37109-7.3438-0.44531-13.801-3.4219-20.258-3.1914-6.9844-8.2578-14.258-13.031-21.684-5.0039-7.3789-9.3125-15.371-14.172-21.938-5.0273-6.8516-10.738-13.559-16.32-20.426-11.148-13.691-22.355-28.188-28.922-45.133-6.8398-16.824-6.6953-36.121 0.26562-52.344-5.5312 16.848-3.9258 35.242 3.8633 50.555 7.5703 15.504 19.379 28.391 31.512 40.945 6.0977 6.3125 12.371 12.516 18.383 19.379 6.2266 7.1406 10.883 14.375 16.379 21.133 3.1797 4.1641 6.4922 8.2695 9.7188 12.719 1.6094-17.914 3.8398-36.121 7.6211-53.762 0.046875-0.48047-0.046875-0.9375 0.085937-1.4141 0.12109-0.45703 0.25391-0.88672 0.44531-1.2969l0.23828-0.53906c0.023438-0.058594 0.070312-0.12109 0.097656-0.17969 5.7969-18.973 13.727-37.402 24.215-54.035 10.703-17.102 23.902-32.242 38.461-45.492-12.395 15.336-22.883 31.992-30.504 49.691-4.0781 9.4062-7.2852 19.078-9.8281 28.906 4.5586-1.7773 9.1562-2.8438 13.586-3.5391 13.402-1.9805 26.074-1.4883 38.676-1.4023 25.02 0.40625 50.137 0.23828 74.258-7.5117-22.98 10.598-48.863 13.945-73.824 16.5-12.469 1.3789-25.043 2.5078-36.277 5.6172-11.293 2.9414-19.246 8.7109-21.758 17.293-5.3398 24.359-7.5469 50.449-9.3359 75.098-0.40625 5.6406-1.4297 11.258-2.7461 16.871-0.15625 0.79297-0.27734 1.5859-0.63672 2.2812-16.535 64.777-83.531 123.38-137.35 141.13 3.457 60.254 11.629 91.105-0.5625 152.4 50.496-78.277 112.92-110.3 173.83-176.65 22.465-24.469 44.027-49.801 63.613-76.668 72.504-99.422 121.08-245.58 56.566-361.56-34.176-61.391-113.69-97.598-173.82-125.47-79.754-36.961-146.43-56.699-167.15-62.23-47.016-12.527-95.555-19.477-144.2-17.316-60.672 2.6992-132.49 26.809-175.37 70.715-45.445 46.535-61.559 112.64-61.223 176.05 0.19141 36.156 4.3672 73.309 11.16 108.83 19.379 101.36 61.32 186.73 128.66 264.77 42.863 49.691 89.473 96 135.74 142.48 20.797 20.879 41.52 42 59.891 65.113 5.8086 7.2852 27.469 32.723 38.531 52.477 10.234-34.02 17.531-69.109 21.602-104.61-0.23828-0.61328-0.45703-1.2227-0.73047-1.8242-1.7383-4.0078-3.9727-8.1016-6.3945-12.121-4.8711-8.0508-10.535-15.898-16.465-23.566-11.914-15.324-24.984-30-38.496-44.23-27.145-28.379-56.172-55.176-87.023-79.789 32.652 22.223 63.77 46.824 93.301 73.344 14.723 13.309 29.062 27.133 42.551 42 5.4727 6.0586 10.715 12.371 15.758 19.008 3.0977-44.207 1.4414-88.586-5.0391-131.65-16.992-13.523-88.414-71.508-124.29-117.64-0.046875-0.070313-0.13281-0.085938-0.19141-0.15625-0.37109-0.43359-0.74219-0.92578-1.0312-1.3789-0.91016-1.4141-1.9453-2.7344-2.9141-4.0938-9.4336-4.3203-21.422-6.1797-33.145-7.0312-15.289-1.0312-31.008-0.61328-46.738-0.13281-31.441 0.97266-63.422 2.8438-94.777-1.4766 31.609 1.3086 62.734-3.5391 94.066-7.4883 15.695-1.9805 31.477-3.9375 47.723-4.4023 3.8281-0.011719 7.7383-0.023438 11.699 0.10937-0.48047-0.30078-0.88672-0.67187-1.3672-0.96094-10.512-6.4805-23.137-10.715-36.133-15.059-13.008-4.332-26.328-9.2383-38.449-16.188-12.18-6.8398-23.004-15.719-32.426-25.559 10.801 8.3867 22.5 15.359 35.004 20.148 12.48 4.8945 25.488 7.6094 38.855 9.9844 13.332 2.4258 27.422 4.7539 41.293 10.645 13.871 5.8203 26.496 15.574 36.371 26.941l0.14453 0.16797c0.011719 0.011719 0.011719 0.023438 0.011719 0.035156 24.926 32.508 70.906 73.008 99.574 97.008-3.5039-16.008-7.6445-31.777-12.527-47.207-2.8672-9.0586-6.8047-17.688-10.969-26.82-6.4219-14.074-12.77-28.656-15.434-45.059-0.011719-0.046876-0.046875-0.070313-0.058594-0.12109-0.69531-2.0039-15.504-44.809-27.227-98.219-12.742-14.398-30.527-24.828-49.512-32.363-21.996-8.6758-45.551-14.27-69.254-19.066-47.508-9.3945-95.953-15.887-143.48-26.27 48.109 7.4414 96.539 10.895 144.98 17.398 24.203 3.3828 48.504 7.5234 72.348 15.254 13.488 4.4414 27.07 10.414 39.457 18.562-7.1523-34.031-20.426-73.5-68.137-117.27-31.391-34.008-70.332-62.387-110.65-87.973 37.906 15.996 75.371 34.094 110.15 58.129 0.73047-7.0938 2.125-14.137 4.3555-20.902 4.4414-13.859 12-26.195 20.723-36.984 17.723-21.504 39.395-38.113 61.309-53.867-20.016 18.023-39.66 37.055-54.012 59.148-7.0664 11.039-12.516 22.883-14.977 35.184-2.0156 9.6602-2.1133 19.512-0.98438 29.352 0.10938 0.070313 0.21484 0.14453 0.3125 0.22656 53.746 49.285 68.734 95.184 76.906 137.44 3.9844 20.543 8.7344 40.211 13.285 57.324 4.5703-16.703 10.777-32.93 16.906-48.875 1.9336-5.0391 3.8633-10.043 5.7227-15.047 6.7305-18.109 13.332-34.523 20.137-50.219 0.023437-0.046876 0.011719-0.085938 0.023437-0.13281 0.19141-0.50391 0.39453-0.99609 0.63672-1.4648l0.10938-0.19141c6.6133-12.613 13.824-25.691 21.254-38.113 7.4297-12.527 15.348-24.77 23.699-36.672 8.3867-11.879 16.98-23.531 26.555-34.535 9.5625-10.945 20.23-21.18 32.617-28.559-11.23 9.0352-20.074 20.34-27.828 32.195-7.7539 11.879-14.555 24.48-21.059 37.105-4.6328 9.0703-8.9297 18.301-13.055 27.59 3.2383-2.1016 6.4805-4.1523 9.7188-6.0586 19.477-11.148 40.031-19.355 60.781-26.438 41.629-13.945 84.312-23.16 127.18-30.625-42.215 10.379-84.109 22.535-124 39.047-19.859 8.3281-39.301 17.746-56.832 29.484-11.438 7.7031-22.391 16.766-30.289 27.086-2.2812 5.9531-4.5234 11.941-6.7305 18.109-0.011719 0.035157-0.011719 0.058594-0.023437 0.097657-6.8867 15.781-13.547 32.352-20.363 50.688-1.8828 5.0742-3.8398 10.176-5.8086 15.289-11.699 30.457-23.797 61.945-22.223 93.77 0.81641 16.262 7.5352 31.02 14.652 46.633 4.2734 9.3711 8.6992 19.078 12 29.508 8.4844 26.762 18.277 52.273 22.754 80.594"/></svg> Watershed to here</button>
        <button type="button" class="btn btn-sm btn-outline-primary" style="text-align: left" id="identify-upstream_rivers"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-emoji-heart-eyes" viewBox="0 0 1024 1024"><path d="M1004.76998 596.019514L974.358471 546.716006a90.543359 90.543359 0 0 0-25.342925-28.107608 88.469847 88.469847 0 0 0-46.078045-13.823414 401.800554 401.800554 0 0 0-105.518724 8.754829l-13.593023-77.641506a143.533111 143.533111 0 0 1-2.764683-58.058337 140.077257 140.077257 0 0 1 32.254632-46.078045 269.095784 269.095784 0 0 0 43.774143-60.592629A46.078045 46.078045 0 0 0 772.536633 230.390226a194.679741 194.679741 0 0 1-29.950729 39.627119 214.26291 214.26291 0 0 0-51.837801 82.24931 216.566812 216.566812 0 0 0 0 99.528578l9.215609 53.220142a271.399686 271.399686 0 0 0-84.783603-26.264486 257.345882 257.345882 0 0 1-48.381948-12.210682 30.87229 30.87229 0 0 1-20.96551-25.112535 46.078045 46.078045 0 0 0-13.132243-60.592629v-4.838195A276.468271 276.468271 0 0 0 490.538997 279.924124a209.424715 209.424715 0 0 0-50.22507-47.690776 1212.082977 1212.082977 0 0 1 215.645252-145.606623A46.078045 46.078045 0 0 0 613.797767 5.298975 1303.317507 1303.317507 0 0 0 353.687203 186.616083a671.817898 671.817898 0 0 0-221.635398-51.14663 46.078045 46.078045 0 1 0-5.068584 92.15609 577.588296 577.588296 0 0 1 153.67028 29.950729c-5.529365 5.759756-11.058731 11.289121-16.588096 17.279267l-2.764683 2.995073a195.601302 195.601302 0 0 1-24.651754 23.039023 195.370911 195.370911 0 0 1-34.558534 18.431218L94.267808 368.624361a46.078045 46.078045 0 1 0 38.244778 83.862042l108.053016-49.073118a271.860466 271.860466 0 0 0 51.37702-28.337998A270.938905 270.938905 0 0 0 329.265839 339.825583l2.534292-2.764683q19.122389-20.73512 38.935948-40.318289a146.988964 146.988964 0 0 1 46.078045 37.783997 196.753253 196.753253 0 0 1 26.034096 64.970043c2.073512 8.063658 3.455853 15.666535 4.838195 23.039023a320.012023 320.012023 0 0 1-57.597557 61.2838l-11.749901 9.215609c-32.715412 25.342925-75.567994 58.749508-85.474774 109.435357A2173.040609 2173.040609 0 0 0 55.33186 575.975564 46.078045 46.078045 0 0 0 6.719523 618.367366a46.078045 46.078045 0 0 0 43.543752 48.612337 2206.447191 2206.447191 0 0 1 261.723297 31.563461 67.273946 67.273946 0 0 1 7.602877 24.882145c0 12.210682-20.50473 27.186047-39.627119 41.700631a368.624361 368.624361 0 0 0-37.783997 31.33307c-71.88175 71.19058-58.288727 142.381159-34.328143 189.611156a46.078045 46.078045 0 1 0 82.01892-41.470241c-13.362633-26.264486-15.436145-50.225069 17.048877-82.24931a175.557352 175.557352 0 0 1 13.362633-11.749902 301.350415 301.350415 0 0 0 109.896138 59.671069l5.990145 1.843122a79.484628 79.484628 0 0 1 15.436146 5.298975 79.023847 79.023847 0 0 1 10.82834 15.666535l38.014387 63.818093a46.078045 46.078045 0 1 0 79.254238-46.078046l-38.014387-63.818092a134.778282 134.778282 0 0 0-35.940875-43.313363 133.856721 133.856721 0 0 0-44.234924-19.352778l-5.068585-1.382342a211.267837 211.267837 0 0 1-66.582775-34.328143 108.744187 108.744187 0 0 0 21.656681-58.058337 102.52365 102.52365 0 0 0 0-13.362633l88.009066 15.436145c49.073118 8.294048 104.597162 17.509657 144.224282 46.078045 8.294048 5.759756 16.588096 12.901853 25.342925 20.50473a309.183683 309.183683 0 0 0 49.533898 36.862436 313.330707 313.330707 0 0 0 94.459993 28.568388 203.204179 203.204179 0 0 1 73.724872 23.039023 46.078045 46.078045 0 1 0 52.298581-76.028775 277.850612 277.850612 0 0 0-107.822626-38.244777 237.762713 237.762713 0 0 1-69.117067-20.50473 233.385299 233.385299 0 0 1-34.558534-26.494876c-9.90678-8.524438-20.27434-17.509657-32.254632-25.803706-56.675996-40.087899-126.253844-51.837801-182.008278-61.053409-38.475168-6.450926-74.646433-12.901853-109.435357-19.122389l-20.965511-3.686244c5.068585-16.818486 29.259559-35.480095 51.14663-52.298581l12.671463-9.90678a408.942651 408.942651 0 0 0 38.935948-35.940875 122.33721 122.33721 0 0 0 46.078045 32.024241 333.605047 333.605047 0 0 0 66.352385 17.509658 171.410328 171.410328 0 0 1 61.744581 18.891998l8.294048 5.990146a128.557746 128.557746 0 0 0 42.161411 23.039023 132.013599 132.013599 0 0 0 76.028774-5.759756l4.838195-1.382341a311.948366 311.948366 0 0 1 104.136382-12.671463L926.667694 645.092632a46.078045 46.078045 0 1 0 77.871896-49.073118z"/></svg> Upstream rivers</button>
        <button type="button" class="btn btn-sm btn-outline-primary" style="text-align: left" id="identify-flowpath"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-emoji-heart-eyes" viewBox="0 0 512 512"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M291.442,200c-117.336-32-144-45.328-96-98.664C229.09,63.953,281.02,25.313,319.208,0h-56.954 C204.63,32.25,139.122,70.984,99.442,120c-45.336,56-30.367,95.711,16,128c74.664,52,166.664,56,109.328,120 c-59.562,66.484-99.539,112.602-134.664,144h266.82c26.821-41.156,73.641-118.211,81.18-165.336 C448.77,280,413.692,233.344,291.442,200z"/></svg> Downstream flowpath</button>
        <button type="button" class="btn btn-sm btn-outline-primary" style="text-align: left" id="identify-all"><i class="bi bi-emoji-sunglasses-fill"></i> All 3 above!</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" style="text-align: left" id="measure-here"><i class="bi bi-rulers"></i> Measure from here</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" style="text-align: left" id="zoom-here"><i class="bi bi-zoom-in"></i> Zoom to here</button>
        <button type="button" class="btn btn-sm btn-outline-danger" style="text-align: left" id="clear-layers"><i class="bi bi-eraser-fill"></i> Clear overlays</button>
      </div>
    `)
    .addTo(map);

  // Save this popup reference
  activeContextMenu = popup_right;
  
  const container = popup_right.getElement();

  const shapeTypes = ["watershed", "upstream_rivers", "flowpath"];
  for (const shapeType of shapeTypes) {
    container.querySelector(`#identify-${shapeType}`)?.addEventListener('click', () => {
      fetchAndDisplayShape(map, comidShape, lngLat.lat, lngLat.lng, shapeType);
      popup_right.remove();
      activeContextMenu = null;
    });
  }

  container.querySelector('#identify-all')?.addEventListener('click', () => {
    identifyAll(map, comidShape, lngLat.lat, lngLat.lng);
    popup_right.remove();
    activeContextMenu = null;
  });

  container.querySelector('#measure-here')?.addEventListener('click', () => {
    enterDistanceMeasureMode(map, lngLat);
    popup_right.remove();
    activeContextMenu = null;
  });

  container.querySelector('#zoom-here')?.addEventListener('click', () => {
    map.flyTo({ center: [lngLat.lng, lngLat.lat], zoom: 10 });
    popup_right.remove();
    activeContextMenu = null;
  });

  container.querySelector('#clear-layers')?.addEventListener('click', () => {
    comidShape = null;
    for (const shapeType of shapeTypes) {
      if (map.getLayer(`${shapeType}-layer`)) map.removeLayer(`${shapeType}-layer`);
      if (map.getSource(shapeType)) map.removeSource(shapeType);
    }
    ['distance-line', 'distance-label'].forEach(id => {
      if (map.getLayer(id)) map.removeLayer(id);
      if (map.getSource(id)) map.removeSource(id);
    });
    activeContextMenu = null;
    popup_right.remove();
  });

}

